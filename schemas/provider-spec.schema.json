{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "https://specado.com/schemas/provider-spec.schema.json",
    "title": "ProviderSpec",
    "description": "Provider capability specification for LLM API translation",
    "type": "object",
    "additionalProperties": false,
    "required": ["spec_version", "provider", "models"],
    "properties": {
      "spec_version": {
        "description": "Specification version (semver)",
        "type": "string",
        "pattern": "^\\d+\\.\\d+\\.\\d+$"
      },
      "provider": {
        "type": "object",
        "additionalProperties": false,
        "required": ["name", "base_url", "headers"],
        "properties": {
          "name": { "type": "string", "minLength": 1 },
          "base_url": { "type": "string", "format": "uri" },
          "headers": {
            "type": "object",
            "description": "Static headers; values may include ${ENV:VAR} placeholders.",
            "additionalProperties": { "type": "string" }
          }
        }
      },
  
      "models": {
        "type": "array",
        "minItems": 1,
        "items": { "$ref": "#/$defs/Model" }
      }
    },
  
    "$defs": {
      "Model": {
        "description": "Model specification within a provider",
        "type": "object",
        "additionalProperties": false,
        "required": ["id", "family", "endpoints", "input_modes", "tooling", "json_output", "parameters", "constraints", "mappings", "response_normalization"],
        "properties": {
          "id": { 
            "description": "Model identifier",
            "type": "string", 
            "minLength": 1 
          },
          "aliases": { 
            "description": "Alternative names/aliases for the model",
            "type": "array", 
            "items": { "type": "string" }
          },
          "family": { 
            "description": "Model family (e.g., gpt-4, claude-3)",
            "type": "string", 
            "minLength": 1 
          },
  
          "endpoints": {
            "description": "API endpoints for this model",
            "type": "object",
            "additionalProperties": false,
            "required": ["chat_completion", "streaming_chat_completion"],
            "properties": {
              "chat_completion": { "$ref": "#/$defs/EndpointConfig" },
              "streaming_chat_completion": { "$ref": "#/$defs/EndpointConfig" }
            }
          },
  
          "input_modes": {
            "type": "object",
            "additionalProperties": false,
            "required": ["messages", "single_text", "images"],
            "properties": {
              "messages": { "type": "boolean" },
              "single_text": { "type": "boolean" },
              "images": { "type": "boolean" }
            }
          },
  
          "tooling": {
            "type": "object",
            "additionalProperties": false,
            "required": ["tools_supported", "parallel_tool_calls_default", "can_disable_parallel_tool_calls"],
            "properties": {
              "tools_supported": { "type": "boolean" },
              "parallel_tool_calls_default": { "type": "boolean" },
              "can_disable_parallel_tool_calls": { "type": "boolean" },
              "disable_switch": {
                "type": "object",
                "additionalProperties": false,
                "required": ["path", "value"],
                "properties": {
                  "path": { "type": "string", "minLength": 1 },
                  "value": {}
                }
              }
            }
          },
  
          "json_output": {
            "type": "object",
            "additionalProperties": false,
            "required": ["native_param", "strategy"],
            "properties": {
              "native_param": { "type": "boolean" },
              "strategy": { "type": "string", "enum": ["json_schema", "prompt_only"] },
              "notes": { "type": "string" }
            }
          },
  
          "parameters": {
            "description": "Parameter mappings and constraints (provider-specific)",
            "type": "object",
            "additionalProperties": true
          },
  
          "constraints": {
            "description": "Provider-specific constraints and limits",
            "type": "object",
            "additionalProperties": false,
            "required": ["system_prompt_location", "forbid_unknown_top_level_fields", "mutually_exclusive", "resolution_preferences", "limits"],
            "properties": {
              "system_prompt_location": { 
                "description": "Where system prompts are placed",
                "type": "string", 
                "enum": ["top_level", "message_role"] 
              },
              "forbid_unknown_top_level_fields": { 
                "description": "Whether unknown fields cause errors",
                "type": "boolean" 
              },
              "mutually_exclusive": {
                "description": "Fields that cannot be used together",
                "type": "array",
                "items": {
                  "type": "array",
                  "minItems": 2,
                  "items": { "type": "string" }
                }
              },
              "resolution_preferences": {
                "description": "Conflict resolution order",
                "type": "array",
                "items": { "type": "string" }
              },
              "limits": {
                "description": "Size limits for various fields",
                "type": "object",
                "additionalProperties": false,
                "required": ["max_tool_schema_bytes", "max_system_prompt_bytes"],
                "properties": {
                  "max_tool_schema_bytes": { "type": "integer", "minimum": 0 },
                  "max_system_prompt_bytes": { "type": "integer", "minimum": 0 }
                }
              }
            }
          },

          "mappings": {
            "description": "Field mappings from uniform to provider format",
            "type": "object",
            "additionalProperties": false,
            "required": ["paths", "flags"],
            "properties": {
              "paths": {
                "description": "JSONPath mappings for fields",
                "type": "object",
                "additionalProperties": { "type": "string" }
              },
              "flags": {
                "description": "Feature flags and their mappings",
                "type": "object",
                "additionalProperties": true
              }
            }
          },

          "response_normalization": {
            "description": "Rules for normalizing provider responses",
            "type": "object",
            "additionalProperties": false,
            "required": ["sync", "stream"],
            "properties": {
              "sync": {
                "description": "Synchronous response normalization",
                "type": "object",
                "additionalProperties": false,
                "required": ["content_path", "finish_reason_path", "finish_reason_map"],
                "properties": {
                  "content_path": { 
                    "description": "JSONPath to response content",
                    "type": "string",
                    "pattern": "^[\\w\\[\\]\\.]+$"
                  },
                  "finish_reason_path": { 
                    "description": "JSONPath to finish reason",
                    "type": "string",
                    "pattern": "^[\\w\\[\\]\\.]+$"
                  },
                  "finish_reason_map": {
                    "description": "Map provider finish reasons to uniform ones",
                    "type": "object",
                    "additionalProperties": { "type": "string" }
                  }
                }
              },
              "stream": {
                "description": "Stream response normalization",
                "type": "object",
                "additionalProperties": false,
                "required": ["protocol", "event_selector"],
                "properties": {
                  "protocol": { 
                    "description": "Streaming technology (over transport protocol)",
                    "type": "string",
                    "enum": ["sse", "websocket", "ndjson", "http2-stream"]
                  },
                  "event_selector": {
                    "description": "Event routing rules",
                    "type": "object",
                    "additionalProperties": false,
                    "required": ["type_path", "routes"],
                    "properties": {
                      "type_path": { 
                        "description": "JSONPath to event type",
                        "type": "string",
                        "pattern": "^[\\w\\[\\]\\.]+$"
                      },
                      "routes": {
                        "description": "Event routing configuration",
                        "type": "array",
                        "items": {
                          "type": "object",
                          "additionalProperties": false,
                          "required": ["when", "emit"],
                          "properties": {
                            "when": { 
                              "description": "Event type to match",
                              "type": "string" 
                            },
                            "emit": { 
                              "description": "Event to emit",
                              "type": "string",
                              "enum": ["start", "delta", "tool", "stop", "error"]
                            },
                            "text_path": { 
                              "type": "string",
                              "pattern": "^[\\w\\[\\]\\.]+$"
                            },
                            "name_path": { 
                              "type": "string",
                              "pattern": "^[\\w\\[\\]\\.]+$"
                            },
                            "args_path": { 
                              "type": "string",
                              "pattern": "^[\\w\\[\\]\\.]+$"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
  
      "EndpointConfig": {
        "description": "API endpoint configuration",
        "type": "object",
        "additionalProperties": false,
        "required": ["method", "path", "protocol"],
        "properties": {
          "method": { 
            "description": "HTTP method",
            "type": "string", 
            "enum": ["POST", "GET", "PUT", "PATCH", "DELETE"] 
          },
          "path": { 
            "description": "URL path",
            "type": "string", 
            "pattern": "^/.*" 
          },
          "protocol": {
            "description": "Transport protocol",
            "type": "string",
            "enum": ["http", "https", "ws", "wss"]
          },
          "query": {
            "description": "Query parameters",
            "type": "object",
            "additionalProperties": { "type": "string" }
          },
          "headers": {
            "description": "Additional headers for this endpoint",
            "type": "object",
            "additionalProperties": { "type": "string" }
          }
        }
      }
    }
  }
  